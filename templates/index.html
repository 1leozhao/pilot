<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
    />
    <title>Pilot</title>
    <!-- Prism.js for Python syntax highlighting -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/prismjs@1.29.0/themes/prism-tomorrow.min.css"
    />
    <style>
      :root {
        color-scheme: dark;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #1f2933, #020617);
        color: #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: stretch;
        min-height: 100vh;
        padding: 8px 12px 16px;
      }
      .shell {
        max-width: 640px;
        width: 100%;
        margin: 6px auto 0;
      }
      .card {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 18px;
        padding: 10px 12px 10px;
        box-shadow: 0 18px 60px rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      button {
        width: 100%;
        border: none;
        border-radius: 999px;
        padding: 14px 16px;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.01em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        color: #e5e7eb;
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
        cursor: pointer;
        transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
          filter 0.08s ease-out;
      }
      button:active {
        transform: translateY(1px) scale(0.99);
        box-shadow: 0 4px 16px rgba(34, 197, 94, 0.45);
        filter: brightness(0.95);
      }
      button[disabled] {
        cursor: default;
        opacity: 0.7;
        box-shadow: none;
      }
      .button-label-main {
        display: block;
      }
      .button-label-sub {
        display: block;
        font-size: 11px;
        font-weight: 500;
        opacity: 0.85;
      }
      .status {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 10px;
        min-height: 16px;
      }
      .answer {
        margin-top: 10px;
        border-radius: 14px;
        background: #020617;
        border: 1px solid rgba(148, 163, 184, 0.5);
        max-height: 50vh;
        overflow-y: auto;
      }
      .answer.empty {
        display: none;
      }
      .answer pre {
        margin: 0;
        padding: 10px 12px;
        font-size: 11px;
        line-height: 1.5;
        background: transparent;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="card">
        <div
          id="modeRow"
          style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;"
        >
          <button
            id="modeCoding"
            class="mode-toggle active"
            style="
              flex: 1;
              padding: 8px 12px;
              font-size: 13px;
              border-radius: 8px;
              background: rgba(29, 78, 216, 0.3);
              color: #e5e7eb;
              border: 1px solid rgba(59, 130, 246, 0.6);
              cursor: pointer;
            "
          >
            Coding
          </button>
          <button
            id="modeQuant"
            class="mode-toggle"
            style="
              flex: 1;
              padding: 8px 12px;
              font-size: 13px;
              border-radius: 8px;
              background: rgba(31, 41, 55, 0.9);
              color: #e5e7eb;
              border: 1px solid rgba(148, 163, 184, 0.5);
              cursor: pointer;
            "
          >
            Quant
          </button>
        </div>
        <div
          id="modelRow"
          style="margin-bottom: 6px; display: flex; gap: 8px; align-items: center;"
        >
          <label for="provider" style="font-size: 12px; opacity: 0.8;">Model</label>
          <select
            id="provider"
            style="
              flex: 1;
              border-radius: 999px;
              padding: 6px 10px;
              font-size: 12px;
              background: rgba(15, 23, 42, 0.9);
              color: #e5e7eb;
              border: 1px solid rgba(148, 163, 184, 0.5);
            "
          >
            <option value="openai" selected>GPT-5.2</option>
            <option value="anthropic">Claude Opus 4.5</option>
          </select>
        </div>
        <button id="actionBtn">
          <span class="button-label-main" id="actionLabel">Start interview</span>
        </button>
        <div class="status" id="status"></div>
        <textarea
          id="feedback"
          placeholder="Optional feedback for the solution"
          style="
            margin-top: 8px;
            width: 100%;
            min-height: 52px;
            resize: vertical;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            padding: 6px 8px;
            font-size: 12px;
            font-family: inherit;
            display: none;
          "
        ></textarea>
        <button
          id="feedbackBtn"
          style="
            margin-top: 6px;
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.01em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: rgba(31, 41, 55, 0.9);
            color: #e5e7eb;
            box-shadow: none;
            display: none;
          "
        >
          <span>Submit feedback &amp; solve</span>
        </button>
        <div
          id="answerToggle"
          style="
            margin-top: 8px;
            display: none;
            gap: 8px;
            align-items: center;
            justify-content: center;
          "
        >
          <button
            id="toggleCodeBtn"
            style="
              flex: 1;
              padding: 8px 12px;
              font-size: 12px;
              border-radius: 8px;
              background: rgba(31, 41, 55, 0.9);
              color: #e5e7eb;
              border: 1px solid rgba(148, 163, 184, 0.5);
              cursor: pointer;
            "
          >
            Code
          </button>
          <button
            id="toggleExplainBtn"
            style="
              flex: 1;
              padding: 8px 12px;
              font-size: 12px;
              border-radius: 8px;
              background: rgba(31, 41, 55, 0.9);
              color: #e5e7eb;
              border: 1px solid rgba(148, 163, 184, 0.5);
              cursor: pointer;
            "
          >
            Explanation
          </button>
        </div>
        <div class="answer empty" id="answer">
          <pre><code id="answerCode" class="language-python"></code></pre>
          <div id="answerText" style="display: none; padding: 10px 12px; font-size: 11px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;"></div>
          <div id="answerExplain" style="display: none; padding: 10px 12px; font-size: 11px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;"></div>
        </div>
      </div>
    </div>
    <script>
      const actionBtn = document.getElementById("actionBtn");
      const actionLabel = document.getElementById("actionLabel");
      const modeRow = document.getElementById("modeRow");
      const modeCodingBtn = document.getElementById("modeCoding");
      const modeQuantBtn = document.getElementById("modeQuant");
      const modelRow = document.getElementById("modelRow");
      const providerEl = document.getElementById("provider");
      const statusEl = document.getElementById("status");
      const answerEl = document.getElementById("answer");
      const answerCodeEl = document.getElementById("answerCode");
      const answerTextEl = document.getElementById("answerText");
      const answerExplainEl = document.getElementById("answerExplain");
      const answerToggle = document.getElementById("answerToggle");
      const toggleCodeBtn = document.getElementById("toggleCodeBtn");
      const toggleExplainBtn = document.getElementById("toggleExplainBtn");
      const feedbackEl = document.getElementById("feedback");
      const feedbackBtn = document.getElementById("feedbackBtn");
      let interviewStarted = false;
      let interviewId = null;
      let currentMode = "coding";
      let currentCode = "";
      let currentText = "";
      let currentExplanation = "";
      let showingCode = true;

      function updateModeUI() {
        const isCoding = currentMode === "coding";
        if (isCoding) {
          modeCodingBtn.style.background = "rgba(29, 78, 216, 0.3)";
          modeCodingBtn.style.borderColor = "rgba(59, 130, 246, 0.6)";
          modeQuantBtn.style.background = "rgba(31, 41, 55, 0.9)";
          modeQuantBtn.style.borderColor = "rgba(148, 163, 184, 0.5)";
          answerToggle.style.display = interviewStarted && currentCode ? "flex" : "none";
          answerCodeEl.style.display = showingCode ? "block" : "none";
          answerTextEl.style.display = "none";
          if (interviewStarted) {
            feedbackEl.style.display = "block";
            feedbackBtn.style.display = "inline-flex";
          }
          if (currentCode) {
            answerEl.classList.remove("empty");
          }
        } else {
          modeCodingBtn.style.background = "rgba(31, 41, 55, 0.9)";
          modeCodingBtn.style.borderColor = "rgba(148, 163, 184, 0.5)";
          modeQuantBtn.style.background = "rgba(29, 78, 216, 0.3)";
          modeQuantBtn.style.borderColor = "rgba(59, 130, 246, 0.6)";
          answerToggle.style.display = "none";
          answerCodeEl.style.display = "none";
          answerTextEl.style.display = currentText ? "block" : "none";
          feedbackEl.style.display = "none";
          feedbackBtn.style.display = "none";
          if (currentText) {
            answerEl.classList.remove("empty");
          }
        }
      }

      modeCodingBtn.addEventListener("click", () => {
        currentMode = "coding";
        updateModeUI();
      });

      modeQuantBtn.addEventListener("click", () => {
        currentMode = "quant";
        updateModeUI();
      });

      function startInterview() {
        if (interviewStarted) return;
        interviewStarted = true;
        if (!interviewId) {
          if (window.crypto && crypto.randomUUID) {
            interviewId = crypto.randomUUID();
          } else {
            interviewId =
              String(Date.now()) + "-" + Math.random().toString(36).slice(2);
          }
        }
        if (modeRow) {
          modeRow.style.display = "none";
        }
        if (modelRow) {
          modelRow.style.display = "none";
        }
        actionLabel.textContent = "Solve from screen";
        const modeText = currentMode === "coding" ? "code" : "problem";
        statusEl.textContent =
          `Interview started. Edit ${modeText} on your screen and tap Solve to update.`;
        updateModeUI();
      }

      async function solve() {
        if (!interviewStarted) {
          startInterview();
        }
        if (actionBtn.disabled) return;
        actionBtn.disabled = true;
        statusEl.textContent = "Capturing screen and solving with "
          + providerEl.options[providerEl.selectedIndex].text
          + "…";
        answerEl.classList.add("empty");
        answerToggle.style.display = "none";
        answerCodeEl.textContent = "";
        answerTextEl.textContent = "";
        answerExplainEl.textContent = "";
        currentCode = "";
        currentText = "";
        currentExplanation = "";

        try {
          const requestBody = {
            provider: providerEl.value,
            interview_id: interviewId,
            mode: currentMode,
          };
          // Only send feedback in coding mode
          if (currentMode === "coding") {
            requestBody.feedback = (feedbackEl.value || "").trim();
          }
          const res = await fetch("/api/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody),
          });
          const data = await res.json();
          if (!data.ok) {
            throw new Error(data.error || "Unknown error");
          }
          statusEl.textContent = "Solution ready.";
          if (currentMode === "quant") {
            currentText = data.answer || "";
            answerTextEl.textContent = currentText;
            answerEl.classList.remove("empty");
            answerTextEl.style.display = "block";
          } else {
            currentCode = data.answer || "";
            answerCodeEl.textContent = currentCode;
            currentExplanation = "";
            showingCode = true;
            answerEl.classList.remove("empty");
            answerToggle.style.display = "flex";
            showCodeView();
            if (window.Prism && Prism.highlightElement) {
              Prism.highlightElement(answerCodeEl);
            }
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + (err.message || String(err));
        } finally {
          actionBtn.disabled = false;
        }
      }

      actionBtn.addEventListener("click", () => {
        if (!interviewStarted) {
          startInterview();
        } else {
          solve();
        }
      });

      function showCodeView() {
        answerCodeEl.style.display = "block";
        answerExplainEl.style.display = "none";
        toggleCodeBtn.style.background = "rgba(29, 78, 216, 0.3)";
        toggleCodeBtn.style.borderColor = "rgba(59, 130, 246, 0.6)";
        toggleExplainBtn.style.background = "rgba(31, 41, 55, 0.9)";
        toggleExplainBtn.style.borderColor = "rgba(148, 163, 184, 0.5)";
        showingCode = true;
      }

      function showExplainView() {
        answerCodeEl.style.display = "none";
        answerExplainEl.style.display = "block";
        toggleCodeBtn.style.background = "rgba(31, 41, 55, 0.9)";
        toggleCodeBtn.style.borderColor = "rgba(148, 163, 184, 0.5)";
        toggleExplainBtn.style.background = "rgba(29, 78, 216, 0.3)";
        toggleExplainBtn.style.borderColor = "rgba(59, 130, 246, 0.6)";
        showingCode = false;
      }

      toggleCodeBtn.addEventListener("click", () => {
        showCodeView();
      });

      toggleExplainBtn.addEventListener("click", async () => {
        if (currentMode !== "coding" || !currentCode) return;
        if (currentExplanation) {
          showExplainView();
          return;
        }
        toggleExplainBtn.disabled = true;
        statusEl.textContent = "Generating explanation…";
        try {
          const res = await fetch("/api/explain", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              provider: providerEl.value,
              interview_id: interviewId,
              code: currentCode,
            }),
          });
          const data = await res.json();
          if (!data.ok) {
            throw new Error(data.error || "Unknown error");
          }
          currentExplanation = data.explanation || "";
          answerExplainEl.textContent = currentExplanation;
          showExplainView();
          statusEl.textContent = "Explanation ready.";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + (err.message || String(err));
        } finally {
          toggleExplainBtn.disabled = false;
        }
      });

      feedbackBtn.addEventListener("click", async () => {
        if (!interviewStarted) {
          startInterview();
        }
        if (feedbackBtn.disabled) return;
        const feedback = (feedbackEl.value || "").trim();
        if (!feedback) {
          feedbackEl.focus();
          return;
        }
        feedbackBtn.disabled = true;
        statusEl.textContent = "Updating solution based on feedback…";

        try {
          if (currentMode === "quant") {
            // For quant mode, use the ask endpoint with feedback
            const res = await fetch("/api/ask", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                provider: providerEl.value,
                interview_id: interviewId,
                feedback,
                mode: currentMode,
              }),
            });
            const data = await res.json();
            if (!data.ok) {
              throw new Error(data.error || "Unknown error");
            }
            statusEl.textContent = "Solution updated from feedback.";
            currentText = data.answer || "";
            answerTextEl.textContent = currentText;
            answerEl.classList.remove("empty");
            answerTextEl.style.display = "block";
            feedbackEl.value = "";
          } else {
            // For coding mode, use the feedback endpoint
            const res = await fetch("/api/feedback", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                provider: providerEl.value,
                interview_id: interviewId,
                feedback,
                code: answerCodeEl.textContent || "",
              }),
            });
            const data = await res.json();
            if (!data.ok) {
              throw new Error(data.error || "Unknown error");
            }
            statusEl.textContent = "Solution updated from feedback.";
            currentCode = data.answer || "";
            answerCodeEl.textContent = currentCode;
            currentExplanation = "";
            showingCode = true;
            answerEl.classList.remove("empty");
            answerToggle.style.display = "flex";
            showCodeView();
            feedbackEl.value = "";
            if (window.Prism && Prism.highlightElement) {
              Prism.highlightElement(answerCodeEl);
            }
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + (err.message || String(err));
        } finally {
          feedbackBtn.disabled = false;
        }
      });
    </script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-clike.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-python.min.js"></script>
  </body>
</html>